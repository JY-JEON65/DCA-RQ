<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>DCA-RQ 설정 통합</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #1a1a1a;
            color: white;
        }
        .container-bg {
            background-color: #111;
        }
        .header-bg {
            background: linear-gradient(to bottom, #3a3a3a, #2a2a2a);
            border-bottom: 1px solid #444;
        }
        .content-bg {
            background-color: #222;
            border: 1px solid #333;
        }
        .btn {
            background: linear-gradient(to bottom, #4a4a4a, #3a3a3a);
            border: 1px solid #555;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-icon {
            font-size: 1.5rem;
        }
        .input-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #1e1e1e;
            border: 1px solid #333;
            margin-bottom: 8px;
            padding-right: 8px;
        }
        .input-label {
            background-color: #333;
            padding: 8px;
            text-align: left;
            flex-grow: 1;
            font-size: 14px;
            color: #e0e0e0;
            min-width: 100px;
        }
        .input-value-container {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        .editable-input {
            background-color: transparent;
            border: none;
            color: #e0e0e0;
            text-align: right;
            padding: 0;
            width: 80px;
            font-size: 1rem;
        }
        .unit-text {
            font-size: 1rem;
            color: #e0e0e0;
            white-space: nowrap;
            margin-left: 4px;
        }
        .section-title {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 12px;
            padding-left: 8px;
            border-left: 3px solid #ffd700;
            font-size: 16px;
        }
        .negative-value {
            color: #ff4d4d; /* Red color for negative values */
        }
        @media (min-width: 768px) {
            .btn-icon {
                font-size: 2rem;
            }
            .btn {
                padding: 0.75rem;
            }
            .input-label {
                padding: 10px;
                font-size: 16px;
                min-width: 140px;
            }
            .editable-input {
                font-size: 1.2rem;
                width: 100px;
            }
            .unit-text {
                font-size: 1.2rem;
            }
            .section-title {
                font-size: 18px;
            }
        }
    </style>
</head>
<body class="p-2 sm:p-4 container-bg">
<div class="max-w-4xl mx-auto">
    <header class="flex flex-col sm:flex-row justify-between items-center p-2 header-bg rounded-t-lg">
        <div class="flex items-center space-x-2 sm:space-x-4 mb-2 sm:mb-0">
            <span class="material-icons text-3xl sm:text-4xl text-green-400">power_settings_new</span>
            <h1 class="text-xl sm:text-2xl font-bold">
                <span class="text-gray-300">DCA-RQ 설정</span>
                <span class="text-gray-500 mx-1 sm:mx-2">•</span>
                <span class="text-gray-400">품목</span>
                <span id="item-name" class="text-white text-lg sm:text-xl font-bold text-yellow-400 px-2 sm:px-4 py-1 rounded"></span>
            </h1>
        </div>
        <div class="flex items-center space-x-1 sm:space-x-2">
            <a href="index.html" class="btn p-2 sm:p-3">
                <span class="material-icons btn-icon text-orange-400">home</span>
            </a>
        </div>
    </header>
    <main class="p-3 sm:p-6 content-bg rounded-b-lg">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-8">
            <div>
                <h2 class="section-title">RQ 측정 설정</h2>
                <div class="input-group">
                    <div class="input-label">측정 주기</div>
                    <div class="input-value-container">
                        <input id="measurement-cycle" class="editable-input" type="number" onchange="updateData(event, 'measurement_cycle')"/>
                        <span class="unit-text">분</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">측정 시간</div>
                    <div class="input-value-container">
                        <input id="measurement-time" class="editable-input" type="number" onchange="updateData(event, 'measurement_time')"/>
                        <span class="unit-text">분</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">측정 횟수</div>
                    <div class="input-value-container">
                        <input id="measurement-count" class="editable-input" type="number" onchange="updateData(event, 'measurement_count')"/>
                        <span class="unit-text">회</span>
                    </div>
                </div>

                <h2 class="section-title mt-6">RQ 입력</h2>
                <div class="input-group">
                    <div class="input-label">설정</div>
                    <div class="input-value-container">
                        <input id="rq-setting" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'rq_setting')"/>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">편차</div>
                    <div class="input-value-container">
                        <span class="unit-text green-text">±</span>
                        <input id="rq-deviation" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'rq_deviation')"/>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">현재 RQ</div>
                    <div class="input-value-container">
                        <input id="current-rq" class="editable-input" type="number" readonly/>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">현재 O₂농도 설정</div>
                    <div class="input-value-container">
                        <input id="current-o2-setting" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'current_o2_setting')"/>
                    </div>
                </div>

                <h2 class="section-title mt-6">O₂ 농도 변화값</h2>
                <div class="input-group">
                    <div class="input-label">RQ 설정값 &gt; RQ 계산값</div>
                    <div class="input-value-container">
                        <input id="o2-change-gt" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'o2_change_gt')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">RQ 설정값 = RQ 계산값</div>
                    <div class="input-value-container">
                        <input id="o2-change-eq" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'o2_change_eq')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">RQ 설정값 &lt; RQ 계산값</div>
                    <div class="input-value-container">
                        <input id="o2-change-lt" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'o2_change_lt')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">RQ 변화 유지 횟수</div>
                    <div class="input-value-container">
                        <input id="rq-change-maintain-count" class="editable-input" type="number" onchange="updateData(event, 'rq_change_maintain_count')"/>
                        <span class="unit-text">회</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">RQ 측정 안정화</div>
                    <div class="input-value-container">
                        <input id="rq-stabilization" class="editable-input" type="number" onchange="updateData(event, 'rq_stabilization')"/>
                        <span class="unit-text">분</span>

                    </div>
                </div>

                <h2 class="section-title mt-6">경고 조건</h2>
                <div class="input-group">
                    <div class="input-label">경보 주기 지점</div>
                    <div class="input-value-container">
                        <input id="alarm-cycle-point" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'alarm_cycle_point')"/>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">경보 알림 편차</div>
                    <div class="input-value-container">
                        <input id="alarm-notification-deviation" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'alarm_notification_deviation')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
            </div>

            <div>
                <h2 class="section-title">DCA-RQ 초기환경 설정값</h2>
                <div class="input-group">
                    <div class="input-label">O₂농도 상한</div>
                    <div class="input-value-container">
                        <input id="o2-upper-limit" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'o2_upper_limit')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">O₂설정</div>
                    <div class="input-value-container">
                        <input id="o2-setting" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'o2_setting')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">O₂편차</div>
                    <div class="input-value-container">
                        <span class="unit-text green-text">±</span>
                        <input id="o2-deviation" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'o2_deviation')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">O₂농도 하한</div>
                    <div class="input-value-container">
                        <input id="o2-lower-limit" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'o2_lower_limit')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label green-text">CO₂설정</div>
                    <div class="input-value-container">
                        <input id="co2-setting" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'co2_setting')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label green-text">CO₂편차</div>
                    <div class="input-value-container">
                        <span class="unit-text green-text">±</span>
                        <input id="co2-deviation" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'co2_deviation')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">O₂설정 초기화</div>
                    <div class="input-value-container">
                        <input id="o2-setting-init" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'o2_setting_init')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">O₂복귀 농도</div>
                    <div class="input-value-container">
                        <input id="o2-recovery-concentration" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'o2_recovery_concentration')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>

                <h2 class="section-title mt-6">기타 설정</h2>
                <div class="input-group">
                    <div class="input-label">저산소 측정주기</div>
                    <div class="input-value-container">
                        <input id="low-oxygen-measurement-cycle" class="editable-input" type="number" onchange="updateData(event, 'low_oxygen_measurement_cycle')"/>
                        <span class="unit-text">회</span>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<script>
    // 전역 변수 선언
    let supabase = null;
    let dcaRqsData = null;

    // Supabase 초기화 함수
    function initializeSupabase() {
        try {
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase library not loaded');
                return false;
            }
            
            // config.js에서 설정 값을 불러옴
            const SUPABASE_URL = window.SUPABASE_CONFIG.SUPABASE_URL;
            const SUPABASE_ANON_KEY = window.SUPABASE_CONFIG.SUPABASE_ANON_KEY;
            
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            return true;
        } catch (error) {
            console.error('Failed to initialize Supabase:', error);
            return false;
        }
    }

    async function fetchDataAndUpdateUI() {
        try {
            if (!supabase) {
                if (!initializeSupabase()) {
                    console.error('Supabase initialization failed');
                    return;
                }
            }

            const { data, error } = await supabase.from('dca_rqs').select('*').limit(1);
            
            if (error) {
                console.error('Database error:', error);
                return;
            }

            if (!data || data.length === 0) {
                console.error('No data found in dca_rqs table');
                return;
            }

            dcaRqsData = data[0];

            document.getElementById('item-name').textContent = dcaRqsData.item;
            
            const fieldsToUpdate = [
                'measurement_cycle', 'measurement_time', 'measurement_count',
                'rq_setting', 'rq_deviation', 'current_o2_setting',
                'o2_change_gt', 'o2_change_eq', 'o2_change_lt',
                'rq_change_maintain_count', 'rq_stabilization',
                'alarm_cycle_point', 'alarm_notification_deviation',
                'o2_upper_limit', 'o2_setting', 'o2_deviation', 'o2_lower_limit',
                'co2_setting', 'co2_deviation', 'o2_setting_init',
                'o2_recovery_concentration', 'low_oxygen_measurement_cycle'
            ];

            fieldsToUpdate.forEach(field => {
                const element = document.getElementById(field.replace(/_/g, '-'));
                if (element) {
                    const value = dcaRqsData[field];
                    element.value = (typeof value === 'number' && field.includes('o2-') || field.includes('rq-') || field.includes('alarm-')) ? value.toFixed(2) : value;
                    if (value < 0) {
                        element.classList.add('negative-value');
                    } else {
                        element.classList.remove('negative-value');
                    }
                }
            });

        } catch (error) {
            console.error('Error fetching data:', error.message);
        }
    }

    function updateCurrentRq() {
        document.getElementById('current-rq').value = '0.00';
    }

    async function updateData(event, field) {
        const inputElement = event.target;
        const value = parseFloat(inputElement.value);

        if (isNaN(value)) {
            alert('유효한 숫자를 입력하세요.');
            return;
        }

        // 음수 값일 때 글씨 색상을 빨간색으로 변경
        inputElement.classList.remove('negative-value');
        if (value < 0) {
            inputElement.classList.add('negative-value');
        }

        if (!dcaRqsData) {
            console.error('Data not loaded yet.');
            return;
        }

        if (!supabase) {
            if (!initializeSupabase()) {
                console.error('Supabase not initialized for update');
                return;
            }
        }

        try {
            const { error } = await supabase
                .from('dca_rqs')
                .update({ [field]: value })
                .eq('id', dcaRqsData.id);

            if (error) throw error;
            console.log(`Successfully updated ${field} to ${value}`);
        } catch (error) {
            console.error('Error updating data:', error.message);
            alert('데이터 업데이트 실패: ' + error.message);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            initializeSupabase();
            fetchDataAndUpdateUI();
            updateCurrentRq();
        }, 100);
    });
</script>
</body>
</html>