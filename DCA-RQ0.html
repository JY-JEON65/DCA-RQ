<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>DCA-RQ ÏÑ§Ï†ï ÌÜµÌï©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #1a1a1a;
            color: white;
        }
        .container-bg {
            background-color: #111;
        }
        .header-bg {
            background: linear-gradient(to bottom, #3a3a3a, #2a2a2a);
            border-bottom: 1px solid #444;
        }
        .content-bg {
            background-color: #222;
            border: 1px solid #333;
        }
        .btn {
            background: linear-gradient(to bottom, #4a4a4a, #3a3a3a);
            border: 1px solid #555;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-icon {
            font-size: 1.5rem;
        }
        .input-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #1e1e1e;
            border: 1px solid #333;
            margin-bottom: 8px;
            padding-right: 8px;
        }
        .input-label {
            background-color: #333;
            padding: 8px;
            text-align: left;
            flex-grow: 1;
            font-size: 14px;
            color: #e0e0e0;
            min-width: 100px;
        }
        .input-value-container {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        .editable-input {
            background-color: transparent;
            border: none;
            color: #e0e0e0;
            text-align: right;
            padding: 0;
            width: 80px;
            font-size: 1rem;
        }
        .unit-text {
            font-size: 1rem;
            color: #e0e0e0;
            white-space: nowrap;
            margin-left: 4px;
        }
        .section-title {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 12px;
            padding-left: 8px;
            border-left: 3px solid #ffd700;
            font-size: 16px;
        }
        .negative-value {
            color: #ff4d4d; /* Red color for negative values */
        }
        @media (min-width: 768px) {
            .btn-icon {
                font-size: 2rem;
            }
            .btn {
                padding: 0.75rem;
            }
            .input-label {
                padding: 10px;
                font-size: 16px;
                min-width: 140px;
            }
            .editable-input {
                font-size: 1.2rem;
                width: 100px;
            }
            .unit-text {
                font-size: 1.2rem;
            }
            .section-title {
                font-size: 18px;
            }
        }
    </style>
</head>
<body class="p-2 sm:p-4 container-bg">
<div class="max-w-4xl mx-auto">
    <header class="flex flex-col sm:flex-row justify-between items-center p-2 header-bg rounded-t-lg">
        <div class="flex items-center space-x-2 sm:space-x-4 mb-2 sm:mb-0">
            <span class="material-icons text-3xl sm:text-4xl text-green-400">power_settings_new</span>
            <h1 class="text-xl sm:text-2xl font-bold">
                <span class="text-gray-300">DCA-RQ ÏÑ§Ï†ï</span>
                <span class="text-gray-500 mx-1 sm:mx-2">‚Ä¢</span>
                <span class="text-gray-400">ÌíàÎ™©</span>
                <span id="item-name" class="text-white text-lg sm:text-xl font-bold text-yellow-400 px-2 sm:px-4 py-1 rounded"></span>
            </h1>
        </div>
        <div class="flex items-center space-x-1 sm:space-x-2">
            <a href="index.html" class="btn p-2 sm:p-3">
                <span class="material-icons btn-icon text-orange-400">home</span>
            </a>
        </div>
    </header>
    <main class="p-3 sm:p-6 content-bg rounded-b-lg">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-8">
            <div>
                <h2 class="section-title">RQ Ï∏°Ï†ï ÏÑ§Ï†ï</h2>
                <div class="input-group">
                    <div class="input-label">Ï∏°Ï†ï Ï£ºÍ∏∞</div>
                    <div class="input-value-container">
                        <input id="measurement-cycle" class="editable-input" type="number" onchange="updateData(event, 'measurement_cycle')"/>
                        <span class="unit-text">Î∂Ñ</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">Ï∏°Ï†ï ÏãúÍ∞Ñ</div>
                    <div class="input-value-container">
                        <input id="measurement-time" class="editable-input" type="number" onchange="updateData(event, 'measurement_time')"/>
                        <span class="unit-text">Î∂Ñ</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">Ï∏°Ï†ï ÌöüÏàò</div>
                    <div class="input-value-container">
                        <input id="measurement-count" class="editable-input" type="number" onchange="updateData(event, 'measurement_count')"/>
                        <span class="unit-text">Ìöå</span>
                    </div>
                </div>

                <h2 class="section-title mt-6">RQ ÏûÖÎ†•</h2>
                <div class="input-group">
                    <div class="input-label">ÏÑ§Ï†ï</div>
                    <div class="input-value-container">
                        <input id="rq-setting" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'rq_setting')"/>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">Ìé∏Ï∞®</div>
                    <div class="input-value-container">
                        <span class="unit-text green-text">¬±</span>
                        <input id="rq-deviation" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'rq_deviation')"/>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">ÌòÑÏû¨ RQ</div>
                    <div class="input-value-container">
                        <input id="current-rq" class="editable-input" type="number" readonly/>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">ÌòÑÏû¨ O‚ÇÇÎÜçÎèÑ ÏÑ§Ï†ï</div>
                    <div class="input-value-container">
                        <input id="current-o2-setting" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'current_o2_setting')"/>
                    </div>
                </div>

                <h2 class="section-title mt-6">O‚ÇÇ ÎÜçÎèÑ Î≥ÄÌôîÍ∞í</h2>
                <div class="input-group">
                    <div class="input-label">RQ ÏÑ§Ï†ïÍ∞í &gt; RQ Í≥ÑÏÇ∞Í∞í</div>
                    <div class="input-value-container">
                        <input id="o2-change-gt" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'o2_change_gt')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">RQ ÏÑ§Ï†ïÍ∞í = RQ Í≥ÑÏÇ∞Í∞í</div>
                    <div class="input-value-container">
                        <input id="o2-change-eq" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'o2_change_eq')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">RQ ÏÑ§Ï†ïÍ∞í &lt; RQ Í≥ÑÏÇ∞Í∞í</div>
                    <div class="input-value-container">
                        <input id="o2-change-lt" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'o2_change_lt')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">RQ Î≥ÄÌôî Ïú†ÏßÄ ÌöüÏàò</div>
                    <div class="input-value-container">
                        <input id="rq-change-maintain-count" class="editable-input" type="number" onchange="updateData(event, 'rq_change_maintain_count')"/>
                        <span class="unit-text">Ìöå</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">RQ Ï∏°Ï†ï ÏïàÏ†ïÌôî</div>
                    <div class="input-value-container">
                        <input id="rq-stabilization" class="editable-input" type="number" onchange="updateData(event, 'rq_stabilization')"/>
                        <span class="unit-text">Î∂Ñ</span>

                    </div>
                </div>

                <h2 class="section-title mt-6">Í≤ΩÍ≥† Ï°∞Í±¥</h2>
                <div class="input-group">
                    <div class="input-label">Í≤ΩÎ≥¥ Ï£ºÍ∏∞ ÏßÄÏ†ê</div>
                    <div class="input-value-container">
                        <input id="alarm-cycle-point" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'alarm_cycle_point')"/>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">Í≤ΩÎ≥¥ ÏïåÎ¶º Ìé∏Ï∞®</div>
                    <div class="input-value-container">
                        <input id="alarm-notification-deviation" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'alarm_notification_deviation')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
            </div>

            <div>
                <h2 class="section-title">DCA-RQ Ï¥àÍ∏∞ÌôòÍ≤Ω ÏÑ§Ï†ïÍ∞í</h2>
                <div class="input-group">
                    <div class="input-label">O‚ÇÇÎÜçÎèÑ ÏÉÅÌïú</div>
                    <div class="input-value-container">
                        <input id="o2-upper-limit" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'o2_upper_limit')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">O‚ÇÇÏÑ§Ï†ï</div>
                    <div class="input-value-container">
                        <input id="o2-setting" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'o2_setting')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">O‚ÇÇÌé∏Ï∞®</div>
                    <div class="input-value-container">
                        <span class="unit-text green-text">¬±</span>
                        <input id="o2-deviation" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'o2_deviation')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">O‚ÇÇÎÜçÎèÑ ÌïòÌïú</div>
                    <div class="input-value-container">
                        <input id="o2-lower-limit" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'o2_lower_limit')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label green-text">CO‚ÇÇÏÑ§Ï†ï</div>
                    <div class="input-value-container">
                        <input id="co2-setting" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'co2_setting')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label green-text">CO‚ÇÇÌé∏Ï∞®</div>
                    <div class="input-value-container">
                        <span class="unit-text green-text">¬±</span>
                        <input id="co2-deviation" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'co2_deviation')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">O‚ÇÇÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî</div>
                    <div class="input-value-container">
                        <input id="o2-setting-init" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'o2_setting_init')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-label">O‚ÇÇÎ≥µÍ∑Ä ÎÜçÎèÑ</div>
                    <div class="input-value-container">
                        <input id="o2-recovery-concentration" class="editable-input" type="number" step="0.01" onchange="updateData(event, 'o2_recovery_concentration')"/>
                        <span class="unit-text">%</span>
                    </div>
                </div>

                <h2 class="section-title mt-6">Í∏∞ÌÉÄ ÏÑ§Ï†ï</h2>
                <div class="input-group">
                    <div class="input-label">Ï†ÄÏÇ∞ÏÜå Ï∏°Ï†ïÏ£ºÍ∏∞</div>
                    <div class="input-value-container">
                        <input id="low-oxygen-measurement-cycle" class="editable-input" type="number" onchange="updateData(event, 'low_oxygen_measurement_cycle')"/>
                        <span class="unit-text">Ìöå</span>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<script>
    // Ï†ÑÏó≠ Î≥ÄÏàò ÏÑ†Ïñ∏
    let supabase = null;
    let dcaRqsData = null;
    
    // üî• Ï∂îÍ∞ÄÎêú Î∂ÄÎ∂Ñ: ÏûÖÎ†•Í∞íÏóêÏÑú Îã®ÏúÑ Î¨∏ÏûêÎ•º Ï†úÍ±∞ÌïòÍ≥† floatÏúºÎ°ú Î≥ÄÌôòÌïòÎäî Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò
    function cleanAndParse(inputValue) {
        // Ïà´Ïûê, ÏÜåÏàòÏ†ê(.), ÎßàÏù¥ÎÑàÏä§(-)Îßå ÎÇ®Í∏∞Í≥† ÎÇòÎ®∏ÏßÄÎäî Ï†úÍ±∞
        const cleaned = inputValue.toString().replace(/[^0-9.\-]/g, ''); 
        return parseFloat(cleaned);
    }

    // Supabase Ï¥àÍ∏∞Ìôî Ìï®Ïàò
    function initializeSupabase() {
        try {
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase library not loaded');
                return false;
            }
            
            // config.jsÏóêÏÑú ÏÑ§Ï†ï Í∞íÏùÑ Î∂àÎü¨Ïò¥
            const SUPABASE_URL = window.SUPABASE_CONFIG.SUPABASE_URL;
            const SUPABASE_ANON_KEY = window.SUPABASE_CONFIG.SUPABASE_ANON_KEY;
            
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            return true;
        } catch (error) {
            console.error('Failed to initialize Supabase:', error);
            return false;
        }
    }

    async function fetchDataAndUpdateUI() {
        try {
            if (!supabase) {
                if (!initializeSupabase()) {
                    console.error('Supabase initialization failed');
                    return;
                }
            }

            const { data, error } = await supabase.from('dca_rqs').select('*').limit(1);
            
            if (error) {
                console.error('Database error:', error);
                return;
            }

            if (!data || data.length === 0) {
                console.error('No data found in dca_rqs table');
                return;
            }

            dcaRqsData = data[0];

            document.getElementById('item-name').textContent = dcaRqsData.item;
            
            const fieldsToUpdate = [
                'measurement_cycle', 'measurement_time', 'measurement_count',
                'rq_setting', 'rq_deviation', 'current_o2_setting',
                'o2_change_gt', 'o2_change_eq', 'o2_change_lt',
                'rq_change_maintain_count', 'rq_stabilization',
                'alarm_cycle_point', 'alarm_notification_deviation',
                'o2_upper_limit', 'o2_setting', 'o2_deviation', 'o2_lower_limit',
                'co2_setting', 'co2_deviation', 'o2_setting_init',
                'o2_recovery_concentration', 'low_oxygen_measurement_cycle'
            ];

            fieldsToUpdate.forEach(field => {
                const element = document.getElementById(field.replace(/_/g, '-'));
                if (element) {
                    const value = dcaRqsData[field];
                    // Ïà´Ïûê Í∞íÏóê ÎåÄÌï¥ ÏÜåÏàòÏ†ê Ï≤òÎ¶¨ Î∞è ÏùåÏàò ÏÉâÏÉÅ Ï≤òÎ¶¨
                    const isDecimal = field.includes('o2_') || field.includes('rq_') || field.includes('alarm_');
                    element.value = (typeof value === 'number' && isDecimal) ? value.toFixed(2) : value;
                    
                    if (value < 0) {
                        element.classList.add('negative-value');
                    } else {
                        element.classList.remove('negative-value');
                    }
                }
            });

        } catch (error) {
            console.error('Error fetching data:', error.message);
        }
    }

    function updateCurrentRq() {
        document.getElementById('current-rq').value = '0.00';
    }

    async function updateData(event, field) {
        const inputElement = event.target;
        // üî• ÏàòÏ†ïÎêú Î∂ÄÎ∂Ñ: cleanAndParse Ï†ÅÏö©
        const value = cleanAndParse(inputElement.value);

        if (isNaN(value)) {
            alert('Ïú†Ìö®Ìïú Ïà´ÏûêÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
            // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûòÎ™ªÎêú Í∞íÏùÑ ÏûÖÎ†•ÌñàÏùÑ Í≤ΩÏö∞, ÏõêÎûòÏùò DB Í∞íÏúºÎ°ú ÎêòÎèåÎ¶¨Îäî Î°úÏßÅÏùÑ Ï∂îÍ∞ÄÌï† ÏàòÎèÑ ÏûàÏäµÎãàÎã§. (ÏÑ†ÌÉù ÏÇ¨Ìï≠)
            return;
        }

        // ÏùåÏàò Í∞íÏùº Îïå Í∏ÄÏî® ÏÉâÏÉÅÏùÑ Îπ®Í∞ÑÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω
        inputElement.classList.remove('negative-value');
        if (value < 0) {
            inputElement.classList.add('negative-value');
        }

        if (!dcaRqsData) {
            console.error('Data not loaded yet.');
            return;
        }

        if (!supabase) {
            if (!initializeSupabase()) {
                console.error('Supabase not initialized for update');
                return;
            }
        }

        try {
            const { error } = await supabase
                .from('dca_rqs')
                .update({ [field]: value })
                .eq('id', dcaRqsData.id);

            if (error) throw error;
            console.log(`Successfully updated ${field} to ${value}`);
        } catch (error) {
            console.error('Error updating data:', error.message);
            alert('Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: ' + error.message);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            initializeSupabase();
            fetchDataAndUpdateUI();
            updateCurrentRq();
        }, 100);
    });
</script>
</body>
</html>