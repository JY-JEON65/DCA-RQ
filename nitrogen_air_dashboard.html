<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>질소 발생기 필요 공기량 대시보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #111827;
            color: #E5E7EB;
        }
        .chart-container {
            position: relative;
            height: 250px; /* 차트 높이 조정 */
        }
    </style>
</head>
<body class="p-4">
<a href="index.html" style="position: absolute; top: 1rem; right: 1rem; z-index: 20;">
    <img src="home.png" alt="Home" style="width: 40px; height: 40px;">
</a>
<header class="flex justify-between items-center mb-4">
    <h1 class="text-xl font-bold text-gray-100">질소 발생기 필요 공기량 대시보드</h1>
</header>
<main class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-xs font-medium text-gray-400 mb-1" for="flowRate">생산 질소량 (Nm³/h)</label>
                <input class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500 text-sm" id="flowRate" type="number" step="any" value="30"/>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-400 mb-1" for="purity">생산 질소순도 (%)</label>
                <input class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500 text-sm" id="purity" type="number" step="any" value="99"/>
            </div>
            <div class="col-span-2">
                <label class="block text-xs font-medium text-gray-400 mb-1" for="airPurity">공기 중 질소순도 (%)</label>
                <input class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500 text-sm" id="airPurity" type="number" step="any" value="78.0"/>
            </div>
        </div>
        <button onclick="performCalculation()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-sm transition duration-300 ease-in-out mb-4">
            계산 및 그래프 생성
        </button>
        
        <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
            <h2 class="text-base font-bold text-center text-gray-100 mb-2">계산 공식 & 데이터</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-xs text-left text-gray-300 mb-2">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                    <tr>
                        <th class="px-3 py-2 rounded-l-lg" colspan="4">회수율</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr class="bg-gray-800 border-b border-gray-700">
                        <th class="px-3 py-2 font-medium text-white whitespace-nowrap" colspan="4">(생산 질소량 × 순도) / (공기량 × 공기중 N₂)</th>
                    </tr>
                    </tbody>
                </table>
                <table class="w-full text-xs text-left text-gray-300">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                    <tr>
                        <th class="px-3 py-2 rounded-l-lg" colspan="4">공기량</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr class="bg-gray-800 border-b border-gray-700">
                        <th class="px-3 py-2 font-medium text-white whitespace-nowrap" colspan="4">(생산량 × 순도) / (회수율 × 공기중 N₂) × 1.1</th>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
        <div class="space-y-2">
            <div class="flex items-center text-sm">
                <span class="material-icons text-green-400 mr-2" style="font-size: 1.25rem;">check_circle</span>
                <span class="font-medium text-gray-300">계산된 회수율:</span>
                <span id="recoveryRate" class="font-bold text-green-400 ml-1">0.00 %</span>
            </div>
            <div class="flex items-center text-sm">
                <span class="material-icons text-blue-400 mr-2" style="font-size: 1.25rem;">calculate</span>
                <span class="font-medium text-gray-300">최종 필요 공기량:</span>
                <span id="requiredAirFlow" class="font-bold text-blue-400 ml-1">0.00 Nm³/h</span>
            </div>
        </div>
        <div class="bg-gray-800 p-4 rounded-xl shadow-lg mt-4 border border-gray-700">
            <h2 class="text-base font-bold text-gray-100 mb-2">PSA Tower 인입조건</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-xs text-left text-gray-300">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                    <tr>
                        <th class="px-3 py-2 rounded-l-lg" scope="col">질소순도 (%)</th>
                        <th class="px-3 py-2" scope="col">회수율 (%)</th>
                        <th class="px-3 py-2" scope="col">순도공기</th>
                        <th class="px-3 py-2 rounded-r-lg" scope="col">비고</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr class="bg-gray-800 border-b border-gray-700">
                        <th class="px-3 py-2 font-medium text-white whitespace-nowrap" scope="row">95</th>
                        <td class="px-3 py-2">68</td>
                        <td class="px-3 py-2">59.11</td>
                        <td class="px-3 py-2" rowspan="5">7bar, 30℃</td>
                    </tr>
                    <tr class="bg-gray-800 border-b border-gray-700">
                        <th class="px-3 py-2 font-medium text-white whitespace-nowrap" scope="row">99</th>
                        <td class="px-3 py-2">50</td>
                        <td class="px-3 py-2">83.77</td>
                    </tr>
                    <tr class="bg-gray-800 border-b border-gray-700">
                        <th class="px-3 py-2 font-medium text-white whitespace-nowrap" scope="row">99.9</th>
                        <td class="px-3 py-2">33</td>
                        <td class="px-3 py-2">128.08</td>
                    </tr>
                    <tr class="bg-gray-800 border-b border-gray-700">
                        <th class="px-3 py-2 font-medium text-white whitespace-nowrap" scope="row">99.99</th>
                        <td class="px-3 py-2">23</td>
                        <td class="px-3 py-2">183.93</td>
                    </tr>
                    <tr class="bg-gray-800">
                        <th class="px-3 py-2 font-medium text-white whitespace-nowrap" scope="row">99.999</th>
                        <td class="px-3 py-2">16</td>
                        <td class="px-3 py-2">264.42</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-span-1 lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
            <h2 class="text-base font-bold text-center text-gray-100 mb-2">질소 농도에 따른 공기 회수율</h2>
            <div class="chart-container">
                <canvas id="recoveryRateChart"></canvas>
            </div>
        </div>
        <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
            <h2 class="text-base font-bold text-center text-gray-100 mb-2">질소 순도에 따른 필요 공기량</h2>
            <div class="chart-container">
                <canvas id="airFlowChart"></canvas>
            </div>
        </div>
    </div>
</main>
<script>
    const RECOVERY_RATE_DATA = {
        95.0: 68.0,
        99.0: 50.0,
        99.9: 33.0,
        99.99: 23.0,
        99.999: 16.0
    };
    const SAFETY_FACTOR = 1.1;

    function getRecoveryRate(nitrogenPurity) {
        const sortedPurities = Object.keys(RECOVERY_RATE_DATA).map(Number).sort((a, b) => a - b);
        if (nitrogenPurity in RECOVERY_RATE_DATA) {
            return RECOVERY_RATE_DATA[nitrogenPurity];
        }
        if (nitrogenPurity < sortedPurities[0]) {
            return RECOVERY_RATE_DATA[sortedPurities[0]];
        }
        if (nitrogenPurity > sortedPurities[sortedPurities.length - 1]) {
            return RECOVERY_RATE_DATA[sortedPurities[sortedPurities.length - 1]];
        }
        for (let i = 0; i < sortedPurities.length - 1; i++) {
            const p1 = sortedPurities[i];
            const p2 = sortedPurities[i + 1];
            if (p1 < nitrogenPurity && nitrogenPurity < p2) {
                const r1 = RECOVERY_RATE_DATA[p1];
                const r2 = RECOVERY_RATE_DATA[p2];
                return r1 + (nitrogenPurity - p1) * (r2 - r1) / (p2 - p1);
            }
        }
        throw new Error("회수율 계산 오류");
    }

    function calculateRequiredAirFlow(flowRate, purity, recoveryRate, airPurity) {
        if (recoveryRate === 0 || airPurity === 0) {
            throw new Error("회수율과 공기 중 질소순도는 0이 될 수 없습니다.");
        }
        const base = (flowRate * purity) / (recoveryRate * airPurity) * SAFETY_FACTOR;
        return base * 100;
    }

    let recoveryRateChart, airFlowChart;

    function initializeCharts() {
        const recoveryRateCtx = document.getElementById('recoveryRateChart').getContext('2d');
        const purities = Object.keys(RECOVERY_RATE_DATA).map(Number).sort((a, b) => a - b);
        const rates = purities.map(p => RECOVERY_RATE_DATA[p]);

        const chartOptions = {
            scales: {
                x: {
                    type: 'linear',
                    title: { display: true, text: '생산 질소 순도 (%)', font: { size: 12 }, color: '#9CA3AF' },
                    ticks: { color: '#E5E7EB', font: { size: 10 } },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    title: { display: true, text: '회수율 (%)', font: { size: 12 }, color: '#9CA3AF' },
                    ticks: { color: '#E5E7EB', font: { size: 10 } },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            },
            plugins: {
                legend: { labels: { color: '#E5E7EB', font: { size: 12 } } }
            },
            responsive: true,
            maintainAspectRatio: false
        };

        recoveryRateChart = new Chart(recoveryRateCtx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: '회수율 데이터',
                        data: purities.map((p, i) => ({ x: p, y: rates[i] })),
                        borderColor: '#34D399',
                        backgroundColor: '#34D399',
                        pointRadius: 3
                    },
                    {
                        label: '계산 지점',
                        data: [{ x: 99, y: 50 }],
                        borderColor: '#EF4444',
                        backgroundColor: '#EF4444',
                        pointRadius: 6,
                        showLine: false
                    }
                ]
            },
            options: {
                ...chartOptions,
                scales: {
                    ...chartOptions.scales,
                    y: {
                        ...chartOptions.scales.y,
                        title: { ...chartOptions.scales.y.title, text: '회수율 (%)' }
                    }
                }
            }
        });

        const airFlowCtx = document.getElementById('airFlowChart').getContext('2d');
        const purityRange = Array.from({ length: 200 }, (_, i) => 95 + (99.999 - 95) * i / 199);
        const airFlowValues = purityRange.map(p => ({
            x: p,
            y: calculateRequiredAirFlow(50, p, getRecoveryRate(p), 78.0)
        }));

        airFlowChart = new Chart(airFlowCtx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'N₂ 50 Nm³/h 기준',
                        data: airFlowValues,
                        borderColor: '#60A5FA',
                        backgroundColor: '#60A5FA',
                        pointRadius: 0,
                        tension: 0.1
                    },
                    {
                        label: '현재 계산 지점',
                        data: [{ x: purity, y: requiredAirFlow }],
                        borderColor: '#EF4444',
                        backgroundColor: '#EF4444',
                        pointRadius: 6,
                        showLine: false
                    }
                ]
            },
            options: {
                ...chartOptions,
                scales: {
                    ...chartOptions.scales,
                    y: {
                        ...chartOptions.scales.y,
                        title: { ...chartOptions.scales.y.title, text: '필요 공기량 (Nm³/h)' }
                    }
                }
            }
        });
    }

    function performCalculation() {
        const flowRate = parseFloat(document.getElementById('flowRate').value);
        const purity = parseFloat(document.getElementById('purity').value);
        const airPurity = parseFloat(document.getElementById('airPurity').value);

        try {
            if (isNaN(flowRate) || isNaN(purity) || isNaN(airPurity) || flowRate <= 0 || purity <= 0 || airPurity <= 0) {
                alert("모든 필드에 유효한 양의 숫자를 입력해 주세요.");
                return;
            }

            const recoveryRate = getRecoveryRate(purity);
            document.getElementById('recoveryRate').textContent = `${recoveryRate.toFixed(2)} %`;

            const requiredAirFlow = calculateRequiredAirFlow(flowRate, purity, recoveryRate, airPurity);
            document.getElementById('requiredAirFlow').textContent = `${requiredAirFlow.toFixed(2)} Nm³/h`;

            recoveryRateChart.data.datasets[1].data = [{ x: purity, y: recoveryRate }];
            recoveryRateChart.update();

            const purityRange = Array.from({ length: 200 }, (_, i) => 95 + (99.999 - 95) * i / 199);
            const airFlowValues = purityRange.map(p => ({
                x: p,
                y: calculateRequiredAirFlow(flowRate, p, getRecoveryRate(p), airPurity)
            }));

            airFlowChart.data.datasets = [
                {
                    label: `N₂ ${flowRate} Nm³/h 기준`,
                    data: airFlowValues,
                    borderColor: '#60A5FA',
                    backgroundColor: '#60A5FA',
                    pointRadius: 0,
                    tension: 0.1
                },
                {
                    label: '현재 계산 지점',
                    data: [{ x: purity, y: requiredAirFlow }],
                    borderColor: '#EF4444',
                    backgroundColor: '#EF4444',
                    pointRadius: 6,
                    showLine: false
                }
            ];
            airFlowChart.update();
        } catch (e) {
            alert(`계산 오류: ${e.message}`);
        }
    }

    window.onload = initializeCharts;
</script>
</body>
</html>